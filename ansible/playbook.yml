- hosts: all
  become: yes
  tasks:
    - name: Install packages
      apt:
        update-cache: yes
        pkg:
          - gpg
          - curl
    - name: Setup Debian 10
      include: debian_10.yml
      when: ansible_facts['distribution'] == "Debian" and ansible_facts['distribution_version'] == "10"
    - name: Setup Ubuntu 18.04
      include: ubuntu_1804.yml
      when: ansible_facts['distribution'] == "Ubuntu" and ansible_facts['distribution_version'] == "18.04"
    - name: Setup Ubuntu 20.04
      include: ubuntu_2004.yml
      when: ansible_facts['distribution'] == "Ubuntu" and ansible_facts['distribution_version'] == "20.04"
    - name: Install packages
      apt:
        update-cache: yes
        pkg:
          - python3-intelmq-api
          - intelmq-manager
          - apache2
    - command: intelmqctl status file-output
      register: intelmqctlstatusfileoutput
      ignore_errors: yes
    - assert:
        that: "'Bot file-output is stopped.' in intelmqctlstatusfileoutput.stdout"
    - command: intelmqctl start file-output
      register: intelmqctlstartfileoutput
    - command: intelmqctl status file-output
      register: intelmqctlstatusfileoutput
      ignore_errors: yes
    - assert:
        that: "'Bot file-output is running.' in intelmqctlstatusfileoutput.stdout"
    - command: curl http://localhost/intelmq/v1/api/queues
      register: curlapiqueues
    - assert:
        that: "'{{ lookup('file', '../assets/00_queues') }}' in curlapiqueues.stdout"
